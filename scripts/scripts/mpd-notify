#!/bin/bash

form="\n[<b>Artist:</b>\t<span color='##a1b56c'>%artist%</span>\n\n][<b>Album:</b>\t<span color='##6a9fb5'>%album%</span>\n\n][<b>Title:</b>\t<span color='##ac4142'>%title%</span>]"

while true
do
    mpc idle player mixer >/dev/null
    volume="$(( $(mpc volume | sed -r "s/volume: {0,2}([0-9]+)%/\1/") / 5 ))"
    volbar="$(python -c "print('['+'X'*$volume+' '*(20-$volume)+']')")"
    toprint="$(mpc current -f "$form" | sed "s/&/&amp;/g" ; echo -e "\nVolume:\t$volbar")"
    if (mpc status -f '%file%' | grep -E "^https?://")
    then
        artpath="$HOME/media/music/radio-covers/$(basename "$(mpc status -f '%file%' | head -n1)").png"
    else
        artpath="$HOME/media/music/$(dirname "$(mpc status -f '%file%' | head -n1)")/cover.*"
    fi
    echo "$artpath"
    rm /tmp/cover.png
    convert -resize 128x128 "$artpath" /tmp/cover.png
    dunstify -a MPDnotify -r 1337 -i "/tmp/cover.png" "                          MPD" "$toprint"
done
